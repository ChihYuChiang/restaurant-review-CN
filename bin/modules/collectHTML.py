from selenium import webdriver
from selenium.webdriver.common.desired_capabilities import DesiredCapabilities

'''
------------------------------------------------------------
Set up webdriver (browser)
------------------------------------------------------------
'''
#--Set options
#Device capability
def setupDcaps():
    dcaps = DesiredCapabilities.PHANTOMJS
    dcaps['phantomjs.page.settings.loadImages'] = False
    dcaps['phantomjs.page.settings.userAgent'] = 'Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2224.3 Safari/537.36'
    return dcaps
dcaps = setupDcaps()

#Additional driver options
DOWNLOAD_TIMEOUT = 20
LOG_PATH = 'log/ghostdriver.log'

#Assign option values
browser = webdriver.PhantomJS(
    desired_capabilities=dcaps,
    service_log_path=LOG_PATH)
browser.set_page_load_timeout(DOWNLOAD_TIMEOUT)








'''
------------------------------------------------------------
Browse and acquire html - restaurant main page
------------------------------------------------------------
'''
#%%
def mainPage(shopId):
    #--Initiate browser (refresh the browser)
    #Replace with .Firefox(), or with the browser of choice (options could be different)
    browser = webdriver.PhantomJS(
        desired_capabilities=dcaps,
        service_log_path=LOG_PATH)
    browser.set_page_load_timeout(DOWNLOAD_TIMEOUT)


    #--Targeting a main page url and navigate to that page
    url = 'http://www.dianping.com/shop/' + str(shopId)
    browser.get(url)


    #--Acquire general user rating generated by JS
    #Actions
    webdriver.ActionChains(browser
        ).click(on_element=browser.find_element_by_css_selector('.brief-info > a.icon')
        ).perform()

    #Get HTML
    HTML_generalScore = browser.execute_script('return document.getElementById("shop-score").innerHTML')


    #--Acquire recommended dishes generated by JS
    #Actions
    try:
        webdriver.ActionChains(browser
            ).click(on_element=browser.find_element_by_css_selector('.recommend-name + .J-more')
            ).perform()

    #Get HTML
        HTML_recDish = browser.execute_script('return document.getElementsByClassName("shop-tab-recommend")[0].innerHTML')
    except: HTML_recDish = None


    #--Acquire main page + basic info generated by JS
    #Actions
    webdriver.ActionChains(browser
        ).click(on_element=browser.find_element_by_css_selector('.basic-info > a.J-unfold')
        ).perform()

    #Get HTML
    HTML_main = browser.execute_script('return document.documentElement.outerHTML')


    #--Return the scraped contents
    return HTML_generalScore, HTML_recDish, HTML_main
